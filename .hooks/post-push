#/bin/sh

rm -rf /builds/fyrious.ninja/ports
rsync -aq /usr/ports/wildefyr/* /builds/fyrious.ninja/ports

cd /builds/fyrious.ninja

printf '\n'
printf '%s\n' "Generate updated portspage:"

cd ports/

httpup-repgen && portspage . | sed '1,43d' | sed -n '/Generated by/q;p' > index.html
cat >> "index.html" << EOF
<li><a href="/ports/wildefyr.git">Git Sync</a></li>
<li><a href="/ports/wildefyr.httpup">Httpup Sync</a></li>
EOF

cd ../
git add ports/
git commit -m 'ports: latest'
git push

printf '\n%s\n\n' "PULLING CHANGES ON TO SERVER:"

ssh fyrious "cd /builds/fyrious.ninja && git pull && ./ports.sh clean; ./ports.sh"
